name: Security - Secret Scan (Redacted)

on:
  pull_request:
  push:
    branches: [develop]

permissions:
  contents: read

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run redacted scan
        run: |
          python3 scripts/secret_scan_redacted.py . --json-out /tmp/secret-scan.json

      - name: Enforce policy (fail on risky tracked findings)
        run: |
          python3 - << 'PY'
          import json, subprocess, sys

          d = json.load(open('/tmp/secret-scan.json'))
          findings = d.get('findings', [])

          def is_tracked(path: str) -> bool:
            r = subprocess.run(['git','ls-files','--error-unmatch',path], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            return r.returncode == 0

          allow_prefixes = (
            'docs/',
            'scripts/',
          )
          allow_exact = {
            'docs/SECURITY_SECRET_SCAN_REPORT_2025_12_21.md',
          }

          def allowed(path: str) -> bool:
            if path in allow_exact:
              return True
            return path.startswith(allow_prefixes)

          hard_fail_categories = {
            'private_key_block',
            'key_material_file',
            'credential_json_file',
            'github_pat_like',
            'slack_token_like',
          }

          failures = []
          for f in findings:
            path = f.get('file') or ''
            cat = f.get('category') or ''
            if not path or not is_tracked(path) or allowed(path):
              continue

            if cat in hard_fail_categories:
              failures.append((cat, path, f.get('line')))
              continue

            if cat == 'dotenv_file':
              failures.append((cat, path, None))
              continue

            if cat == 'inline_secret_assignment':
              # Enforce in app/src trees only, but ignore test/spec fixtures.
              if path.startswith(('frontend-react-native/src/', 'apps/', 'packages/')):
                if any(token in path for token in ('/__tests__/', '.test.', '.spec.')):
                  continue
                failures.append((cat, path, f.get('line')))

          if failures:
            print('Secret scan failed (redacted). Findings:')
            for cat, path, line in failures[:200]:
              loc = f'{path}' + (f':L{line}' if line else '')
              print(f' - {cat}: {loc}')
            sys.exit(1)

          print('Secret scan passed.')
          PY
