apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: ios-build-task
  namespace: tekton-pipelines
  labels:
    app: cerebral-mobile
    component: ios-build
spec:
  description: Build and sign iOS app for TestFlight deployment
  params:
    - name: repo-url
      type: string
      description: Git repository URL
    - name: repo-branch
      type: string
      default: main
      description: Git branch to clone
    - name: ios-cert-secret
      type: string
      default: ios-signing-cert
      description: Kubernetes secret containing iOS signing certificate
  workspaces:
    - name: shared-data
      description: Shared workspace for repository and build artifacts

  steps:
    - name: clone-repo
      image: alpine/git:latest
      script: |
        #!/bin/sh
        set -e

        echo "üîÑ Cloning repository..."
        cd $(workspaces.shared-data.path)
        git clone -b $(params.repo-branch) $(params.repo-url) repo
        cd repo

        echo "‚úÖ Repository cloned successfully"
        git log --oneline -1

    - name: setup-ios-environment
      image: ghcr.io/cirruslabs/macos-runner:latest
      env:
        - name: CI_SIGNING_CERTIFICATE
          valueFrom:
            secretKeyRef:
              name: $(params.ios-cert-secret)
              key: cert.p12
        - name: CI_PROVISIONING_PROFILE
          valueFrom:
            secretKeyRef:
              name: $(params.ios-cert-secret)
              key: profile.mobileprovision
        - name: CERT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ios-cert-secret)
              key: cert-password
      script: |
        #!/bin/bash
        set -e

        cd $(workspaces.shared-data.path)/repo/frontend-react-native

        echo "üîÑ Setting up iOS environment..."

        # Install Node dependencies
        echo "üì¶ Installing Node dependencies..."
        npm install -g pnpm
        pnpm install --frozen-lockfile

        # Install CocoaPods dependencies
        echo "üì¶ Installing CocoaPods dependencies..."
        cd ios
        pod install
        cd ..

        # Import signing certificate
        echo "üîê Importing iOS signing certificate..."
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp "$CI_PROVISIONING_PROFILE" ~/Library/MobileDevice/Provisioning\ Profiles/

        echo "‚úÖ iOS environment setup complete"

    - name: build-ios-archive
      image: ghcr.io/cirruslabs/macos-runner:latest
      script: |
        #!/bin/bash
        set -e

        cd $(workspaces.shared-data.path)/repo/frontend-react-native

        echo "üèóÔ∏è  Building iOS archive..."

        xcodebuild \
          -workspace ios/CerebralNative.xcworkspace \
          -scheme CerebralNative \
          -configuration Release \
          -derivedDataPath build \
          -archivePath build/CerebralNative.xcarchive \
          -allowProvisioningUpdates \
          archive

        echo "‚úÖ iOS archive created successfully"
        ls -lh build/CerebralNative.xcarchive

    - name: export-ipa
      image: ghcr.io/cirruslabs/macos-runner:latest
      script: |
        #!/bin/bash
        set -e

        cd $(workspaces.shared-data.path)/repo/frontend-react-native

        echo "üì¶ Exporting IPA..."

        # Create ExportOptions.plist if it doesn't exist
        if [ ! -f ios/ExportOptions.plist ]; then
          cat > ios/ExportOptions.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>app-store</string>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>stripSwiftSymbols</key>
    <true/>
    <key>teamID</key>
    <string></string>
    <key>thinning</key>
    <string><none></string>
</dict>
</plist>
EOF
        fi

        xcodebuild \
          -exportArchive \
          -archivePath build/CerebralNative.xcarchive \
          -exportOptionsPlist ios/ExportOptions.plist \
          -exportPath build/output

        echo "‚úÖ IPA exported successfully"
        ls -lh build/output/CerebralNative.ipa

    - name: verify-build
      image: alpine:latest
      script: |
        #!/bin/sh
        set -e

        echo "üîç Verifying build artifacts..."

        IPA_FILE=$(workspaces.shared-data.path)/repo/frontend-react-native/build/output/CerebralNative.ipa

        if [ -f "$IPA_FILE" ]; then
          FILE_SIZE=$(stat -f%z "$IPA_FILE" 2>/dev/null || stat -c%s "$IPA_FILE" 2>/dev/null || echo "unknown")
          echo "‚úÖ Build verification passed"
          echo "   IPA file size: $FILE_SIZE bytes"
          echo "   Location: $IPA_FILE"
        else
          echo "‚ùå Build verification failed: IPA file not found"
          exit 1
        fi
