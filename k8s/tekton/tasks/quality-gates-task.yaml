apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cerebral-mobile-quality-gates
  namespace: tekton-pipelines
  labels:
    app: cerebral-mobile
    component: quality
spec:
  description: Run quality gates (lint, tests, typecheck, guardrails) before platform builds.
  workspaces:
    - name: source
      description: Workspace containing the cloned repo at source/repo
  steps:
    - name: quality
      image: node:20-bullseye
      workingDir: $(workspaces.source.path)/repo
      script: |
        #!/bin/bash
        set -euo pipefail

        echo "üì¶ Installing pnpm..."
        npm install -g pnpm@9

        echo "üì¶ Installing dependencies (workspace)..."
        pnpm install --frozen-lockfile

        echo "üìù Linting..."
        pnpm run lint

        echo "üß™ Tests..."
        pnpm run test -- --passWithNoTests

        echo "üîç Typecheck..."
        pnpm exec tsc --noEmit

        echo "üõ°Ô∏è Guardrails (diff-based ratchet)..."
        BASE_SHA="$(git rev-parse HEAD~1 2>/dev/null || printf '')"
        HEAD_SHA="$(git rev-parse HEAD)"
        if [[ -n "$BASE_SHA" ]]; then
          node tools/guardrails/check-diff.mjs --base "$BASE_SHA" --head "$HEAD_SHA"
        else
          echo "‚ÑπÔ∏è  No base ref available; skipping diff guardrails"
        fi
