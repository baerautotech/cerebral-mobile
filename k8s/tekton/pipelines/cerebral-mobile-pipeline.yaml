apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: cerebral-mobile-pipeline
  namespace: tekton-pipelines
  labels:
    app: cerebral-mobile
    version: v1
spec:
  description: Complete CI/CD pipeline for Cerebral React Native mobile app (iOS + Android)

  params:
    # Required parameters
    - name: repo-url
      type: string
      description: Git repository URL (e.g., https://github.com/baerautotech/cerebral-mobile-1)

    # Optional parameters with defaults
    - name: repo-branch
      type: string
      default: main
      description: Git branch to build

    - name: build-target
      type: string
      default: all
      description: "Build target: ios, android, or all"

    - name: version
      type: string
      default: "1.0.0"
      description: App version (semver format)

    - name: ios-cert-secret
      type: string
      default: ios-signing-cert
      description: Kubernetes secret containing iOS signing certificate
    - name: ios-runner-host
      type: string
      default: ""
      description: Mac Studio SSH host for remote iOS builds (empty = use in-cluster iOS task)

    - name: ios-runner-user
      type: string
      default: build
      description: Mac Studio SSH user

    - name: ios-runner-workdir
      type: string
      default: /Users/build/ci/cerebral-mobile
      description: Remote workdir on Mac Studio

    - name: android-keystore-secret
      type: string
      default: android-keystore
      description: Kubernetes secret containing Android keystore

  workspaces:
    - name: shared-workspace
      description: Shared workspace for all tasks

  tasks:
    # Task 1: Clone repository
    - name: git-clone
      taskRef:
        name: cerebral-mobile-clone-repo
      params:
        - name: repo-url
          value: $(params.repo-url)
        - name: repo-branch
          value: $(params.repo-branch)
      workspaces:
        - name: output
          workspace: shared-workspace

    # Task 2: Quality gates
    - name: quality-gates
      runAfter:
        - git-clone
      taskRef:
        name: cerebral-mobile-quality-gates
      workspaces:
        - name: source
          workspace: shared-workspace

    # Task 3: Build iOS (conditional) (conditional)
    - name: build-ios
      when:
        - input: $(params.build-target)
          operator: in
          values: ["ios", "all"]
        - input: $(params.ios-runner-host)
          operator: in
          values: [""]
      runAfter:
        - quality-gates
      taskRef:
        name: ios-build-task
      params:
        - name: repo-url
          value: $(params.repo-url)
        - name: repo-branch
          value: $(params.repo-branch)
        - name: ios-cert-secret
          value: $(params.ios-cert-secret)
      workspaces:
        - name: shared-data
          workspace: shared-workspace

    # Task 5: Build Android (conditional)

    # Task: Build iOS on remote Mac Studio (conditional)
    - name: build-ios-remote
      when:
        - input: $(params.build-target)
          operator: in
          values: ["ios", "all"]
        - input: $(params.ios-runner-host)
          operator: notin
          values: [""]
      runAfter:
        - quality-gates
      taskRef:
        name: cerebral-mobile-ios-remote-macstudio
      params:
        - name: repo-url
          value: $(params.repo-url)
        - name: repo-branch
          value: $(params.repo-branch)
        - name: mac-host
          value: $(params.ios-runner-host)
        - name: mac-user
          value: $(params.ios-runner-user)
        - name: mac-workdir
          value: $(params.ios-runner-workdir)
    - name: build-android
      when:
        - input: $(params.build-target)
          operator: in
          values: ["android", "all"]
      runAfter:
        - quality-gates
      taskRef:
        name: android-build-task
      params:
        - name: repo-url
          value: $(params.repo-url)
        - name: repo-branch
          value: $(params.repo-branch)
        - name: android-keystore-secret
          value: $(params.android-keystore-secret)
      workspaces:
        - name: shared-data
          workspace: shared-workspace

    # Task 6: Build Docker image for web
    - name: build-docker-image
      runAfter:
        - build-ios
        - build-ios-remote
        - build-android
      taskRef:
        name: kaniko
      params:
        - name: IMAGE
          value: 10.34.0.202:5000/cerebral/mobile:$(params.version)
        - name: DOCKERFILE
          value: ./Dockerfile.build
        - name: CONTEXT
          value: ./frontend-react-native
        - name: EXTRA_ARGS
          value:
            - --cache=true
            - --cache-repo=10.34.0.202:5000/cerebral/mobile-cache
      workspaces:
        - name: source
          workspace: shared-workspace

  finally:
    # Final task: Notification
    - name: notify-completion
      taskRef:
        name: slack-notification
      params:
        - name: message
          value: |
            ðŸš€ Cerebral Mobile Build $(params.build-target)
            Version: $(params.version)
            Branch: $(params.repo-branch)
            Status: $(tasks.status)
      onFailure:
        - build-ios
        - build-android
        - build-docker-image
