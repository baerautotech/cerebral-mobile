---
description: AUTHORITATIVE Supabase Operations Protocol - Use ONLY this method for all database operations
globs: ["*"]
alwaysApply: true
---

# üéØ **SUPABASE OPERATIONS - AUTHORITATIVE PROTOCOL**

**STATUS**: Verified working November 7, 2025 - PRODUCTION TESTED
**REPLACES**: All previous Supabase connection documentation
**PRIORITY**: P0 - MANDATORY FOR ALL DATABASE OPERATIONS

---

## ‚úÖ **THE ONLY METHOD THAT WORKS - ALWAYS USE THIS**

### **Step 1: Import Correct Client**

```python
from backend_python.shared.database.supabase.client import get_admin_client
```

**Why**: This client is in `backend_python/shared/database/supabase/client.py` and has:
- Connection pooling (MAX_CONCURRENT_CONNECTIONS = 10)
- Retry logic (MAX_RETRIES = 3 with exponential backoff)
- Timeout management (CONNECTION_TIMEOUT = 30s, REQUEST_TIMEOUT = 15s)
- Production-ready error handling

### **Step 2: Get Client with Environment Variables**

```python
client = await get_admin_client()  # Uses SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY
```

**Client Configuration** (from `client.py`):
- Reads: `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` from environment
- Auto-refresh token: `True`
- Persist session: `True`
- PostgreSQL timeout: 30 seconds
- Storage timeout: 15 seconds

### **Step 3: Execute SQL Operations**

```python
# For any SQL operation (DDL, DML, queries):
result = client.rpc("run_sql", {"query": sql_statement}).execute()
```

**CRITICAL**: `client.rpc("run_sql", {...})` is the ONLY method that works for:
- CREATE FUNCTION (RPC functions)
- CREATE TABLE / ALTER TABLE
- INSERT / UPDATE / DELETE
- SELECT queries
- Any other SQL operation

---

## üöÄ **EXECUTION ENVIRONMENT - CRITICAL REQUIREMENTS**

### **Package Manager: Always Use UV**

```bash
/Users/bbaer/.local/bin/uv run python3 your_script.py
```

**Why UV**:
- ‚úÖ Already installed at `/Users/bbaer/.local/bin/uv`
- ‚úÖ Properly isolates Python environment
- ‚úÖ Passes environment variables to subprocess correctly
- ‚úÖ No pip permission issues
- ‚úÖ Used in production for backend-python

### **Credentials: Pass as Environment Variables**

```bash
# CORRECT - Pass credentials directly on command line:
SUPABASE_URL="https://your-project.supabase.co" \
SUPABASE_SERVICE_ROLE_KEY="your-service-key" \
/Users/bbaer/.local/bin/uv run python3 script.py

# WRONG - These DON'T WORK:
source .env && uv run python3 script.py  # ‚ùå Credentials won't pass to subprocess
python3 script.py  # ‚ùå Env vars not set
pip install supabase  # ‚ùå System pip permission error
```

---

## üî¥ **WHAT DOESN'T WORK - NEVER USE THESE**

| Method | Why It Fails |
|--------|-------------|
| `source .env && uv run python3` | Environment variables don't pass to uv subprocess |
| `pip install supabase` | System Python permission error (use uv instead) |
| Manual SQL files | Manual steps mean inconsistency and failures |
| Supabase REST API for DDL | DDL requires RPC calls (`client.rpc()`) |
| Direct `psycopg2` connection | Use abstraction layer for auth and pooling |
| Local Dashboard manually | Code-based deployment is repeatable and reliable |
| `asyncio.run()` in subprocess | Use uv which handles async properly |

---

## ‚úÖ **COMPLETE WORKING EXAMPLE**

**File: `/tmp/create_kg_functions.py`**

```python
#!/usr/bin/env python3
import asyncio
import sys
sys.path.insert(0, '/Users/bbaer/Development/cerebral/backend_python')

async def main():
    from shared.database.supabase.client import get_admin_client
    client = await get_admin_client()

    sql = """
    CREATE OR REPLACE FUNCTION create_kg_entity(
        entity_id TEXT, entity_type TEXT, entity_data JSONB,
        tenant_id TEXT DEFAULT '00000000-0000-0000-0000-000000000100'
    ) RETURNS JSONB AS $$
    BEGIN
        INSERT INTO kg_entities (id, type, data, tenant_id, created_at, updated_at)
        VALUES (entity_id, entity_type, entity_data, tenant_id, NOW(), NOW());
        RETURN jsonb_build_object('success', true, 'entity_id', entity_id);
    END;
    $$ LANGUAGE plpgsql;
    """

    result = client.rpc("run_sql", {"query": sql}).execute()
    print("‚úÖ Function created successfully")
    return True

asyncio.run(main())
```

**Execution**:

```bash
SUPABASE_URL="https://project.supabase.co" \
SUPABASE_SERVICE_ROLE_KEY="key" \
/Users/bbaer/.local/bin/uv run python3 /tmp/create_kg_functions.py
```

**Result**:
```
‚úÖ Function created successfully
```

---

## üö® **MANDATORY ENFORCEMENT RULES**

### **ALWAYS DO THIS:**
1. ‚úÖ Use `get_admin_client()` from `backend_python/shared/database/supabase/client.py`
2. ‚úÖ Use `/Users/bbaer/.local/bin/uv run python3` for execution
3. ‚úÖ Pass credentials as environment variables on command line
4. ‚úÖ Use `client.rpc("run_sql", {"query": sql}).execute()` for all SQL
5. ‚úÖ Handle exceptions with proper error messages

### **NEVER DO THIS:**
1. ‚ùå Create new Supabase connection methods
2. ‚ùå Use `source .env` with uv
3. ‚ùå Try system pip install
4. ‚ùå Use REST API for DDL statements
5. ‚ùå Fall back to manual Dashboard steps
6. ‚ùå Assume env vars are passed through shells
7. ‚ùå Use asyncio.run() without proper setup

---

## üíæ **ZERO FAILURE CHECKLIST**

Before running any Supabase operation:

- [ ] Import: `from backend_python.shared.database.supabase.client import get_admin_client`
- [ ] Client: `client = await get_admin_client()`
- [ ] Execute: `client.rpc("run_sql", {"query": sql}).execute()`
- [ ] Environment: `SUPABASE_URL=... SUPABASE_SERVICE_ROLE_KEY=... /Users/bbaer/.local/bin/uv run python3`
- [ ] No manual Dashboard steps - code-only deployment
- [ ] Exception handling for connection errors

---

## üéØ **WHY THIS PROTOCOL PREVENTS FAILURE**

1. **Battle-Tested**: Verified working November 7, 2025 - successfully created 6 RPC functions
2. **Connection Pooling**: Handles multiple concurrent operations safely
3. **Retry Logic**: Automatic recovery from transient failures
4. **Timeout Management**: Prevents hanging operations
5. **Error Handling**: Clear error messages for debugging
6. **Single Source of Truth**: All Supabase operations go through same client
7. **Environment Isolation**: uv ensures clean Python environment
8. **Credential Security**: SERVICE_ROLE_KEY properly managed

---

**THIS IS THE DEFINITIVE PROTOCOL. FOLLOW IT EXACTLY EVERY TIME FOR 100% SUCCESS.**
