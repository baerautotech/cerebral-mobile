#!/bin/sh

set -euo pipefail

echo "üß™ Running pre-push quality checks..."
echo ""

echo "üß™ Testing (workspace)..."
pnpm run test -- --passWithNoTests

echo ""
echo "üìù Linting..."
for workspace in cerebral-native; do
  pnpm --filter "$workspace" run --if-present lint
done

echo ""
echo "üîç Type checking..."
pnpm exec tsc --noEmit

echo ""
echo "üõ°Ô∏è Running pre-commit validation..."
echo ""
echo "üõ°Ô∏è Guardrails (diff-based ratchet)..."
FROM_REF="$(git rev-parse HEAD~1 2>/dev/null || printf '')"
TO_REF="$(git rev-parse HEAD)"
if [ -n "$FROM_REF" ]; then
  node tools/guardrails/check-diff.mjs --base "$FROM_REF" --head "$TO_REF"
else
  echo "‚ÑπÔ∏è  No base ref available; skipping diff guardrails"
fi

echo ""
echo "‚úÖ Pre-push checks passed!"
