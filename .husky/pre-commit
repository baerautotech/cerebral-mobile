#!/bin/bash
# ğŸ›¡ï¸ UNIVERSAL PRE-COMMIT HOOK v5.0
# Language-aware validation for: Python, JavaScript, React, TypeScript, Rust, Java, Swift, Kotlin
# Runs only the tools appropriate for detected languages

set -euo pipefail

echo "ğŸ›¡ï¸ Running universal pre-commit validation..."

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Load detection results if available
if [ -f ".phase-1-5-detection.json" ]; then
    HAS_PACKAGE_JSON=$(grep -o '"has_package_json": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    HAS_PYPROJECT_TOML=$(grep -o '"has_pyproject_toml": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    HAS_CARGO_TOML=$(grep -o '"has_cargo_toml": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    HAS_POM_XML=$(grep -o '"has_pom_xml": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    HAS_BUILD_GRADLE=$(grep -o '"has_build_gradle": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    HAS_SWIFT_FILES=$(grep -o '"has_swift_files": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    HAS_KOTLIN_FILES=$(grep -o '"has_kotlin_files": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    NEEDS_JEST=$(grep -o '"jest": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    NEEDS_ESLINT=$(grep -o '"eslint": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    NEEDS_PYTEST=$(grep -o '"pytest": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    NEEDS_CARGO=$(grep -o '"cargo": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    NEEDS_CHECKSTYLE=$(grep -o '"checkstyle": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    NEEDS_SWIFTLINT=$(grep -o '"swiftlint": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
    NEEDS_KTLINT=$(grep -o '"ktlint": true' .phase-1-5-detection.json > /dev/null && echo true || echo false)
else
    # Fallback: detect on the fly
    HAS_PACKAGE_JSON=false
    HAS_PYPROJECT_TOML=false
    HAS_CARGO_TOML=false
    HAS_POM_XML=false
    HAS_BUILD_GRADLE=false
    HAS_SWIFT_FILES=false
    HAS_KOTLIN_FILES=false
    NEEDS_JEST=false
    NEEDS_ESLINT=false
    NEEDS_PYTEST=false
    NEEDS_CARGO=false
    NEEDS_CHECKSTYLE=false
    NEEDS_SWIFTLINT=false
    NEEDS_KTLINT=false
    
    [ -f "package.json" ] && HAS_PACKAGE_JSON=true
    [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -d "backend-python" ] && HAS_PYPROJECT_TOML=true
    [ -f "Cargo.toml" ] && HAS_CARGO_TOML=true
    [ -f "pom.xml" ] && HAS_POM_XML=true
    [ -f "build.gradle" ] || [ -f "build.gradle.kts" ] && HAS_BUILD_GRADLE=true
    find . -maxdepth 3 -name "*.swift" -type f 2>/dev/null | grep -q . && HAS_SWIFT_FILES=true
    find . -maxdepth 3 -name "*.kt" -type f 2>/dev/null | grep -q . && HAS_KOTLIN_FILES=true
    [ "$HAS_PACKAGE_JSON" = true ] && NEEDS_JEST=true
    [ "$HAS_PACKAGE_JSON" = true ] && NEEDS_ESLINT=true
    [ "$HAS_PYPROJECT_TOML" = true ] && NEEDS_PYTEST=true
    [ "$HAS_CARGO_TOML" = true ] && NEEDS_CARGO=true
    [ "$HAS_POM_XML" = true ] || [ "$HAS_BUILD_GRADLE" = true ] && NEEDS_CHECKSTYLE=true
    [ "$HAS_SWIFT_FILES" = true ] && NEEDS_SWIFTLINT=true
    [ "$HAS_KOTLIN_FILES" = true ] && NEEDS_KTLINT=true
fi

EXIT_CODE=0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JAVASCRIPT/NODE.JS VALIDATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$HAS_PACKAGE_JSON" = true ]; then
    echo ""
    echo "ğŸ“¦ Running JavaScript/Node.js validations..."
    
    # ESLint
    if [ "$NEEDS_ESLINT" = true ] && command -v eslint &> /dev/null; then
        echo "  ğŸ” Running ESLint..."
        if ! pnpm exec eslint --fix . 2>/dev/null; then
            echo "  âš ï¸  ESLint issues detected (auto-fixed where possible)"
        else
            echo "  âœ… ESLint passed"
        fi
    fi
    
    # Prettier
    if command -v prettier &> /dev/null; then
        echo "  âœ¨ Checking Prettier formatting..."
        if ! pnpm exec prettier --check . 2>/dev/null; then
            echo "  âš ï¸  Prettier formatting issues detected"
            EXIT_CODE=1
        else
            echo "  âœ… Prettier check passed"
        fi
    fi
    
    # Jest
    if [ "$NEEDS_JEST" = true ] && command -v jest &> /dev/null; then
        echo "  ğŸ§ª Running Jest tests..."
        if ! pnpm run test -- --bail --onlyChanged 2>/dev/null; then
            echo "  âŒ Jest tests failed"
            EXIT_CODE=1
        else
            echo "  âœ… Jest tests passed"
        fi
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PYTHON VALIDATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$HAS_PYPROJECT_TOML" = true ]; then
    echo ""
    echo "ğŸ Running Python validations..."
    
    # Pylint
    if command -v pylint &> /dev/null; then
        echo "  ğŸ” Running pylint..."
        STAGED_PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)
        if [ -n "$STAGED_PYTHON_FILES" ]; then
            if ! pylint $STAGED_PYTHON_FILES 2>/dev/null; then
                echo "  âš ï¸  Pylint issues detected (non-blocking)"
            else
                echo "  âœ… Pylint passed"
            fi
        fi
    fi
    
    # Black
    if command -v black &> /dev/null; then
        echo "  â¬› Checking Black formatting..."
        STAGED_PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)
        if [ -n "$STAGED_PYTHON_FILES" ]; then
            if ! black --check $STAGED_PYTHON_FILES 2>/dev/null; then
                echo "  âš ï¸  Black formatting issues detected"
            else
                echo "  âœ… Black check passed"
            fi
        fi
    fi
    
    # Pytest
    if [ "$NEEDS_PYTEST" = true ] && command -v pytest &> /dev/null; then
        echo "  ğŸ§ª Running pytest..."
        if pytest --co -q 2>/dev/null | head -1 | grep -q "test session"; then
            if pytest --tb=short 2>/dev/null; then
                echo "  âœ… Pytest passed"
            else
                echo "  âŒ Pytest failed"
                EXIT_CODE=1
            fi
        else
            echo "  âš ï¸  No pytest tests found (expected for some projects)"
        fi
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RUST VALIDATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$HAS_CARGO_TOML" = true ]; then
    echo ""
    echo "ğŸ¦€ Running Rust validations..."
    
    # Cargo check
    if [ "$NEEDS_CARGO" = true ] && command -v cargo &> /dev/null; then
        echo "  ğŸ” Running cargo check..."
        if ! cargo check 2>/dev/null; then
            echo "  âŒ Cargo check failed"
            EXIT_CODE=1
        else
            echo "  âœ… Cargo check passed"
        fi
    fi
    
    # Clippy
    if command -v cargo &> /dev/null && cargo clippy --version &> /dev/null 2>&1; then
        echo "  ğŸ”— Running clippy (Rust linter)..."
        if ! cargo clippy --all-targets --all-features 2>/dev/null; then
            echo "  âš ï¸  Clippy warnings detected (non-blocking)"
        else
            echo "  âœ… Clippy passed"
        fi
    fi
    
    # Rustfmt
    if command -v rustfmt &> /dev/null; then
        echo "  ğŸ“ Checking rustfmt (Rust formatter)..."
        STAGED_RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)
        if [ -n "$STAGED_RUST_FILES" ]; then
            if ! rustfmt --check $STAGED_RUST_FILES 2>/dev/null; then
                echo "  âš ï¸  Rustfmt formatting issues detected"
            else
                echo "  âœ… Rustfmt check passed"
            fi
        fi
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JAVA VALIDATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$HAS_POM_XML" = true ]; then
    echo ""
    echo "â˜• Running Java/Maven validations..."
    
    # Maven compile
    if command -v mvn &> /dev/null; then
        echo "  ğŸ” Running maven compile..."
        if ! mvn clean compile 2>/dev/null; then
            echo "  âŒ Maven compile failed"
            EXIT_CODE=1
        else
            echo "  âœ… Maven compile passed"
        fi
    fi
    
    # Checkstyle
    if command -v mvn &> /dev/null; then
        echo "  âœ”ï¸  Running checkstyle (Java style checker)..."
        if ! mvn checkstyle:check 2>/dev/null; then
            echo "  âš ï¸  Checkstyle violations detected"
        else
            echo "  âœ… Checkstyle passed"
        fi
    fi
fi

if [ "$HAS_BUILD_GRADLE" = true ]; then
    echo ""
    echo "â˜• Running Java/Gradle validations..."
    
    # Gradle build
    if command -v gradle &> /dev/null || [ -f "gradlew" ]; then
        echo "  ğŸ” Running gradle build..."
        GRADLE_CMD="gradle"
        [ -f "gradlew" ] && GRADLE_CMD="./gradlew"
        if ! $GRADLE_CMD build 2>/dev/null; then
            echo "  âŒ Gradle build failed"
            EXIT_CODE=1
        else
            echo "  âœ… Gradle build passed"
        fi
    fi
    
    # Checkstyle
    if command -v gradle &> /dev/null || [ -f "gradlew" ]; then
        echo "  âœ”ï¸  Running checkstyle (Java style checker)..."
        GRADLE_CMD="gradle"
        [ -f "gradlew" ] && GRADLE_CMD="./gradlew"
        if ! $GRADLE_CMD checkstyleMain 2>/dev/null; then
            echo "  âš ï¸  Checkstyle violations detected"
        else
            echo "  âœ… Checkstyle passed"
        fi
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SWIFT VALIDATIONS (iOS/macOS/watchOS)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$HAS_SWIFT_FILES" = true ]; then
    echo ""
    echo "ğŸ Running Swift validations (iOS/macOS/watchOS)..."
    
    # SwiftLint
    if [ "$NEEDS_SWIFTLINT" = true ] && command -v swiftlint &> /dev/null; then
        echo "  ğŸ” Running swiftlint..."
        STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.swift$' || true)
        if [ -n "$STAGED_SWIFT_FILES" ]; then
            if ! swiftlint lint $STAGED_SWIFT_FILES 2>/dev/null; then
                echo "  âš ï¸  SwiftLint issues detected (non-blocking)"
            else
                echo "  âœ… SwiftLint passed"
            fi
        fi
    fi
    
    # SwiftFormat
    if command -v swiftformat &> /dev/null; then
        echo "  âœ¨ Checking swiftformat..."
        STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.swift$' || true)
        if [ -n "$STAGED_SWIFT_FILES" ]; then
            if ! swiftformat --lint $STAGED_SWIFT_FILES 2>/dev/null; then
                echo "  âš ï¸  SwiftFormat issues detected"
            else
                echo "  âœ… SwiftFormat check passed"
            fi
        fi
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KOTLIN VALIDATIONS (Android/Kotlin Multiplatform)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$HAS_KOTLIN_FILES" = true ]; then
    echo ""
    echo "ğŸ¤– Running Kotlin validations (Android/Kotlin Multiplatform)..."
    
    # Ktlint
    if [ "$NEEDS_KTLINT" = true ] && command -v ktlint &> /dev/null; then
        echo "  ğŸ” Running ktlint..."
        STAGED_KOTLIN_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.kt$' || true)
        if [ -n "$STAGED_KOTLIN_FILES" ]; then
            if ! ktlint $STAGED_KOTLIN_FILES 2>/dev/null; then
                echo "  âš ï¸  Ktlint issues detected (non-blocking)"
            else
                echo "  âœ… Ktlint passed"
            fi
        fi
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UNIVERSAL VALIDATIONS (All Repos)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
echo "ğŸ” Running universal validations..."

# TypeScript check (if applicable)
if [ -f "tsconfig.json" ] && command -v tsc &> /dev/null; then
    echo "  ğŸ“˜ Checking TypeScript..."
    if ! tsc --noEmit 2>/dev/null; then
        echo "  âŒ TypeScript validation failed"
        EXIT_CODE=1
    else
        echo "  âœ… TypeScript check passed"
    fi
fi

# Workspace integrity
if [ -f "pnpm-workspace.yaml" ] || [ -f "lerna.json" ]; then
    echo "  ğŸ—ï¸  Validating workspace structure..."
    if ! pnpm install --dry-run 2>/dev/null; then
        echo "  âŒ Workspace integrity check failed"
        EXIT_CODE=1
    else
        echo "  âœ… Workspace structure valid"
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FINAL RESULT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ… All pre-commit validations passed!"
    exit 0
else
    echo "âŒ Pre-commit validation failed. Please fix issues before committing."
    exit 1
fi
